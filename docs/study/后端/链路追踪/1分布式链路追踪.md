来源：马哥教育、王老师
# skywalking

## 分布式链路追踪

### 可观测的监控系统
1. 基于Metrics指标的监控系统
2. 基于Logging日志的监控系统
3. 基于Tracing调用链的监控系统

### 分布式链路追踪历史
早期计算机几乎所有程序都运行在单一的主机节点，互相也没有依赖。硬件成本大幅降低，软件复杂度越来越高，单一系统性能无法满足复杂的数据计算。单节点的可靠性也难以保障。性能、可用性和可伸缩性问题逐渐显现。

微服务框架的演进，单体按照服务维度拆分，组织架构也随之以横向、纵向维度拆分；微服务高内聚低耦合的优势，但低耦合也有明显副作用，在现实沟通、协作带来开销。因此需要系统拓扑和分析性能问题的工具，在架构调整、性能检测和故障时，缩减沟通协作上的问题

微服务技术如容器、k8s等，部署、开发、分布式云较为容易、但系统维护和问题诊断难度急剧上升。因此分布式链路追踪提供确定性关联的价值很重要

常见问题
- 快速发现问题
- 判断故障影响范围
- 服务依赖并判断依赖的合理性
分析链路性能并实施容量规划

OpenTracing为分布式追踪规范，有许多主流的分布式链路追踪Tracing系统：skywalking、CAT、jaeger

#### 分布式链路追踪原理
一种用于监视和调试分布式系统中请求的传播路径的技术

1. 基本原理
- 在分布式应用的接口方法上设置一些观察点，在入口节点给每个请求分配一个全局唯一的标识TraceId，请求流经观察点时会记录一行对应的链路日志（包含链路唯一标识、接口名称、时间戳、主机信息等）。最后通过TraceId将一次请求的所有链路日志进行组装，还原出该次请求的链路轨迹

核心原理是追踪和关联

- 追踪 跟踪一个请求在分布式系统中的完整路径
- 关联 同一个请求的不同部分关联起来

2. 实现流程
+ 客户端发起请求，生成一个唯一的TraceId
+ TraceId会在整个请求过程中传递，并在每个服务中记录下来
+ 每个服务会记录请求的开始时间和结束时间，调用参数、返回值等信息，并将其与TraceId关联起来
+ 所有的Span信息会被收集到一个集中存储系统中
+ 用户可查询系统查看完整的调用链路，并分析性能瓶颈、错误原因、依赖关系等


##### Trace
代表一个请求在分布式系统中的完整路径
- 全局唯一的链路标识TraceId，通过它，TraceID我们将同一个请求分散在不同节点的链路数据准确的关联起来，实现请求粒度的确定性关联价值

##### Span
了解每一个请求在每一个接口方法上执行的动作，耗时多久，执行状态是成功还是失败

承载这些信息的基础对象就是Span，跨度Span是追踪中的具有开始时间和执行时长的基本逻辑运行单元，代表请求在系统中的一个特定操作或组件上的执行。每个跟踪段标识一个操作的时间片段，记录操作开始和结束时间、操作名称、标签等信息

如一个HTTP请求、数据库查询等都可以是一个跟踪段。在分布式系统中串联起来，形成完整的调用链路

##### Context Propagation
分布式系统中的请求通常会经过多个不同的服务和组件，能在整个调用链中追踪请求，需要共享上下文信息。

上下文传递确保请求在跨越不同服务，相关信息请求ID、时间戳能被正确传递，后续调用能识别并追踪这个请求且保持一致性


##### Tag（标签）
- 用于Span中添加元数据的机制，表现为多个key/value对
- 对Span进行注解和补充，记录相关信息，如请求参数、响应状态
- Tag没有时间戳信息

### skywalking
可观测分析平台（OAP），应用性能管理系统（APM），专为微服务、云原生架构和基于容器架构设计

基于OpenTracing规范，核心功能包括分布式追踪、应用性能监控、告警和警报以及可视化分析。准确获取系统中每个服务之间的调用关系

#### 功能和特点
+ 监控
+ 自动探针
+ 高效 轻量
+ 模块化，UI、存储和集群管理
+ 支持告警
+ 可视化

#### 组成
+ OAP 
    - Observability Analysis Platform，负责接收Agent发送的Tracing数据信息，分析Analysis Core，存储到外部存储器Storage，最终提供查询Query功能

+ Storage
    - Tracing数据存储，默认使用H2内存存储，但无法持久化。生产建议采用ES

+ Skywalking-UI
    - 负责提供控台，查看链路等

+ Agent
    - 负责从应用中收集链路信息，发送给skywalking OAP服务器

#### 生产架构
Agent 上报数据给OAP端，有grpc通道和kafka通道，数据量很大，grpc通道可能撑不住，用过kafaka通道削峰；（间接收集数据）


#### 概念
+ Service
    - 应用
+ Endpoint
    - API接口，传入请求的服务中的路径
+ Instance
    - 进程或Pod容器，表现为Ip:Port
+ Segment
    - 一次请求在某个服务内的执行链路片段的合集，一个请求在多个服务中先后产生的Segment会被合并成一个Trace


### 安装部署


(一小时玩转分布式链路追踪系统Skywalking)[https://www.bilibili.com/video/BV16r421b76L/?spm_id_from=444.41.top_right_bar_window_custom_collection.content.click&vd_source=917ef87e48a267f0acc88f766dea0a6e]

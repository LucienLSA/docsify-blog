
# 网络编程

1. 掌握互联网协议基本原理，掌握各种应用的工作机制，http、smtp、dns、ftp
2. 掌握开发一个c/s架构的联网软件

## 网络通信
TCP/IP网络协议标准

### 数据的封装
程序员负责应用层数据的处理（最上层）
1. 应用层的数据可使用某些协议进行封装，也可不封装
2. 需要调用发送数据的接口函数，将数据发送出去
3. 调用API做底层数据处理
- 传输层使用传输层协议打包数据
- 网络层使用网络层协议打包数据
- 网络接口层使用网络接口层协议打包数据
- 数据被发送到internet
4. 接收端接收到发送端的数据
- 程序猿调用接收数据的函数接收数据
- 调用的API做相关的底层处理:
网络接口层拆包 ==> 网络层的包
网络层拆包 ==> 网络层的包
传输层拆包 ==> 传输层数据
- 如果应用层也使用了协议对数据进行了封装，数据的包的解析需要程序猿做

### 网络层次划分

定义开发“开放系统互联参考模型”，OSI七层模型。

#### 物理层

传递二进制电信号的介质形式

#### 链路层

链路层定义主机的身份。必须标识每组电信号特征，分组按顺序发出。以太网协议，一组电信号为一个数据包，一个数据包又称为一帧。一个数据最多1500字节

首部（14个字节，包含MAC地址、源地址和类型）+数据（）+尾部（4个字节，数据帧校验序列，用于确定数据包传输过程是否损坏）

- MAC地址，指身份信息，标识每台电脑唯一地址。网卡为接入网络设备必须安装网络适配器。数据包从一网卡传送到另一网卡。网卡地址即数据包的发送地址和接收地址。

交换机工作在链路层，（以太网、网桥）

#### 网络层

网络层定义IP地址。作用：为数据包选择路由（比如快递从上海选择某条路发到宜宾）。定义网络地址，区分网段，子网内MAC寻址，对不同子网的数据包进行路由。

##### 路由器/路由协议

对不同网络进行隔离，防止广播风暴。不同网络之间的数据转发。路由器实现不同网络数据转发的功能，必须知道所有人的MAC地址

- IP地址：住址，保存有整个村的地址，不同村之间（路由）通信，村长之间互相认识，先找村长，再去问目标人的具体在哪个村，哪个地址
- MAC地址：身份证号

1. 路由表
   记录到其它网段的路径
2. 路由协议

- RIP路由协议
- BGP路由协议

3. IP数据包

网络层被包装的数据包称为IP数据包。

IPv4数据包由首部和数据两部分组成，首部长度为20字节，包含目标IP地址和源IP地址。目标IP地址是网关路由的线索和依据；数据部分的最大长度为65515字节

##### IP协议

1. IPv4地址构成规则

IPv4地址是一个32位bit构成的地址，4个字节，4个十进制数表示。0.0.0.0 - 255.255.255.255。2**32=43亿。为解决ip地址不够用的问题。

- IPv6,128bit,2**128
- 通过NAT端口映射技术实现共享IP地址，ip+端口

2. IP地址的网络位和主机位

- 网络位是用来表示网段--> 如192.168.11.0 一个网段，包含主机1-254，但0不能用，255是广播地址
- 主机位是用来表示具体主机--> 如192.168.11.4， 4是主机位

3. IP地址分类

- A类：第一个字节为网络号，后三个字节为主机号。最前面为0，大型网络
- B类：前两个字节为网络号，后两个字节为主机号。最前面为10，中等规模网络
- C类：前三个字节为网络号，最后一个字节为主机号。最前面为110，小型网络
- D类：最前面为1110，多播地址
- E类：最前面为1111，保留地址

4. 私有地址
   ABC类中，各保留3个区域作为私有地址，仅能在局域网使用，地址范围

回环地址：127.0.0.1，本机地址，等效于localhost或本机IP，作为测试本机TCP/IP是否正常

局域网只能配置私有地址，互联网上网必须有公有地址（运营商或权威机构分配的）。

特殊的B类地址段 169.254.0.0/16
IP网络中每台主机都需要一个IP地址，通过DHCP服务器自动分配。出现169则说明没有获取到合法的ip地址，无法上网。

5. 本地网络与远程网络

本地网络：属于同一个网段；远程网络：不在同一个网段

6. 子网掩码概念与作用

加入A、B的ip为A:193.100.100.180-185   B:193.100.100.193-200。发一个广播，这个网段的所有主机都能收到。

作用：确保AB不在同一个网段，进行子网划分，减少IP地址浪费，减小广播风暴范围。

子网掩码以标识一个ip所处的网段。

- 子网掩码由长度为32位二进制数组成的一个地址
- 子网掩码32位与IP地址32位相对应，IP地址如果某位是网络地址，则子网掩码为1，否则为0

子网掩码如何区分两个IP是不是在同一个网段？拿两个IP分别跟子网掩码作与运算，得出结果，就是每个IP地址的网段。

A 193.100.100.100属于193.100.100.0 地址范围为1-127

第一个网络地址不能用，最后一个广播地址不能用

B 193.100.100.130属于193.100.100.128 地址范围为128-255

A: 0 1 1 0 0 1 0 0 = 100
mask: 1 0 0 0 0 0 0 0
and: 0 0 0 0 0 0 0 0 = 0
B: 1 0 0 0 0 0 1 0 = 130
mask: 1 0 0 0 0 0 0 0
and: 1 0 0 0 0 0 0 0 = 128

#### 传输层

提供端到端的接口 (1-65535个端口)  每个端口可绑定一个应用程序以监听这个端口。所有端口收到的数据，都会转给绑定这个应用程序来处理。

**端口**
端口作用是定位到主机上的某一个进程，通过端口进程可以接受到对应的网络数据 

计算机所有进程都不需要关联一个端口，如果该进程不需要网络通信，则该进程不需要绑定端口，一个端口只能给某一进程使用，多个进程不能同时使用同一个端口

1000以下端口一般都是系统保留的端口，开发程序一般用大于1000的端口。

IP + 端口 可以标识一个网络程序。固定协议端口：http 80   dns 53   smtp 25  ftp 20/21   ssh 22   mysql 3306   rdp 389   ssl 443

（IP地址定位某一台主机，端口定位到主机上的某一个进程）

根据链路层定义的MAC地址，网络层定义IP地址，向两台主机之间的进程进行提供数据的传输。数据包从主机上某个应用程序发出来，由对方主机的某个应用程序接收。

- 用户数据协议(UDP传输)：user datagram protocol 提供无连接的尽最大努力数据传输，但不保证数据的安全性
- 传输控制协议(TCP传输)：transmisson control protocol 提供面向连接可靠的数据传输服务。

##### TCP包中的FLAGS字段

SYN表示建立连接，FIN表示关闭连接，ACK表示响应，PSH表示DATA数据传输，RST表示连接重置

- 三次握手（建立连接）
  **客户端向服务端发起连接，先发一包连接请求数据进行询问（第一次），能否建立连接，这包数据称为SYN。若服务端同意连接，则回复一包SYN+ACK包（第二次），客户端收到之后回复一包ACK包建立连接（第三次）。三次握手之后，客户端和服务端进入了数据传输状态**

为什么不是两次握手？防止因已失效的请求报文，突然传到服务器引起错误。

一包数据可能拆成多包发送，如何处理丢包问题？如何处理乱序问题？
TCP协议为每一个连接，建立一个发送缓冲区，从建立连接后的第一个字节的序列号为0，后面每个字节的序列号就会增加1。发送数据时，从发送缓冲区取一部分数据组成发送报文（tcp协议头中附带序列号和长度），接收端在收到数据后需要回复确认报文（ACK等于接收序列号+长度=下一包数据起始序列号）。发送端也可一次发送连续的多包数据，接收端只需要回复一次ACK就可以，发送端可把待发送的数据分割成一系列的碎片，发送到对端，对端根据序列号和长度重组。可丢失重发，客户端检测到接收确认返回超时，超时重传。全双工

- 四次挥手（中断连接）
  **客户端主动发起连接关闭请求，将服务端发起一包FIN包，自己进入终止等待1状态（第一次），服务端收到FIN包，发送一包ACK包，自己进入关闭等待状态，客户端进入终止等待2状态（第二次）。服务端可发送未发送数据，客户端可接收数据，待服务端发送完数据之后，发送一包FIN包，进入最后确认状态（第三次）。客户端收到之后回复ACK包，进入超时等待状态，经过超时时间后关闭连接，服务端收到ACK包后，立即关闭连接（第四次）。**

为什么客户端需要等待超时时间？为保证对方已收到ACK包，因为假设客户端发送完最后一包ACK包后释放了连接，一旦ACK包在网络中丢失，服务端将一直停留在最后确认状态。如果客户端发送最后一包ACK包后，等待一段时间，这时服务端因没有收到ACK包会重发FIN包，客户端会响应这个FIN包，重发ACK包并刷新超时时间。

##### UDP协议

UDP协议是基于非连接的，发送数据简单将数据包封装，从网卡发出去就可以。数据包之间没有状态上的联系。性能损耗非常少，cpu内存资源占用远小于tcp，对网络传输过程中产生的丢包，udp协议不能保证，稳定性弱于tcp

##### TCP和UDP协议的区别

TCP协议是有确认机制的UDP协议

- UDP是无连接的，直接给对方发数据，速度快；TCP是面向连接（通话前，需要先拨号连接上对方，且对方确认接电话才能够通信，最后对方需要挂掉电话，才断开连接）
- UDP只尽力传输，不保证数据可靠性。TCP安全性很高，有两个传输的端点，是点对点，一对一的形式
- UDP是无报文（聊天室、弹幕），TCP是有可靠的报文交互，传输的数据无差错
- UDP支持一对一、一对多、多对一、多对多的交互通信（聊天室、直播）

##### 隧道网络

VPN

#### 会话层

解除或建立与别的节点的会话关系

#### 表示层

数据格式化、代码转化、数据加密

#### 应用层

提供文件传输、邮件、文件共享、数据加密等

主要通过进程间的数据交互完成特定的网络应用。对于不同的网络应用需要不同的网络协议。如域名解析系统：DNS协议，Web服务用万维网HTTP协议，邮件传输用SMTP协议。

DNS协议(domain name system)

DNS为互联的分布式数据库，主要存储IP和域名的关系。让普通用户方便使用，访问互联网，不用记繁琐的ip地址。

DNS服务器是将域名指向对应IP地址的服务器。DNS服务器中保存了一张域名和与之相对应的IP地址的表，以解析消息的域名。

www.baidu.com   -->   ip地址 123.206.16.61

 HTTP协议(HyperTest Transfer Protocol)超文本传输协议

为了方便发布和接收HTML文件(前端的网页文件)的目的

### TCP/IP模型

数据链路层、网络层、传输层和应用层

### 消息是如何发送到对方电脑

1. 邮信

- 装信封-》tcp包首
- 信封（地址，邮编）-》ip包首
- 邮票和邮局章-》以太网包

2. 拆信

- 对方住所附近邮局
- 邮递员送到你手里
- 打开信封

在一个局域网，通信 广播 ，所有连接到交换机的设备，都可以收到消息，它们会解包消息，检查包首的目标MAC地址，如果不是对应的，则丢弃。目标收到消息，则处理消息。

广播风暴-流量浪费，网络拥堵。

解决方案：

1. 每个人先自我介绍（广播）
2. 班委记录下每个人信息
3. 再找人，则先找班委，查找对应人的信息

交换机中的MAC地址表，存放本网络所有电脑的MAC地址

## ifconfig

1. 网卡ip地址信息等网络参数信息，查看显示网络接口信息，类似于window的ipconfig

ifconfig只能用root操作，且可能需要单独安装

查看指定网卡信息

```bash
ifconfig ens33
```

网络设备查询

```bash
ls /etc/sysconfig/network-scripts/
cat /etc/sysconfig/network-scripts/ifcfg-ens33
```

ipv4地址inet 查询
广播地址broadcast
子网掩码地址netmask

RX/TX 代表网卡收发的流量数据包大小

2. 指定开启或关闭网卡(学习时在虚拟机中使用)

ifconfig 设备名字 up/down

3. 修改和设置ip地址

添加一个新的ip地址

```bash
ifconfig ens330 192.168.178.111 netmask 255.255.255.0 up
ifconfig ens331 192.168.178.120/24 up
```

4. 修改MAC地址信息

```bash
ifconfig ens33 hw ether MAC地址
```

查看MAC地址信息

```bash
ifconfig |grep ether
```

5. 永久修改网络设备信息

ifconfig只是临时修改网络配置，永久修改需要写入配置文件中

```bash
vim /etc/sysconfig/network-scripts/ifcfg-设备名
```

## route路由

计算机之间的数据传输必须经过网络，网络可以直接两台计算机，也可以通过一个一个节点去连接。路由为互联网中转站，网络中数据包通过一个一个的路由器转发到目的地

route程序对linux内核IP路由表进行的操作

### 路由分类

静态和动态路由

linux配置的都是静态路由，route命令管理。
动态路由无需人为干预，由路由器和交换机自动分配规则

### route学习

1. 查看路由表信息，内核IP路由表

```bash
route
```

不进行dns解析的路由表查看

```bash
route -n
```

Destination: 表示网络号，network
Gateway: 表示网关地址，网络是通过该ip出口，如果显示0.0.0.0，表示该路由信息是从本机转发出去的
Genmask: 子网掩码地址的表示，ip地址配合子网掩码，才是完整的网络信息
Flags: 路由标记，标记当前网络的状态。

- U up状态
- G 网关路由器
- H 网关是一个主机
- ! 当前这个路由已禁止

2. 添加和删除网关信息

网关就是通过数据包不经过任何的设定，由路由表最后经过的地址关口。关口好比家里的门，外出需要通过这个门，才能出去，数据也是一样，只能通过这个网关地址出外网

删除default默认路由表

```bash
route del default
```

添加一个网关地址

```bash
route add default gw 网关地址
```

3. 路由跟踪

- linux

```bash
traceroute baidu.com
```

- windows

```bash
tracert baidu.com
```

检测发出数据包的主机到目标主机之间所经过的网关数量（一共经过多少路由）。追踪网络数据包的路由途径，预设数据包大小是40Bytes

## ip命令

包含ifconfig和route，查看系统路由、网络设备、设置策略等功能

### ip命令可操作的对象

link 网络设备； address 定义ipv4 ipv6的地址； neighbour 查看ARP缓存地址（用于解析MAC地址）； route 路由表对象； maddress 多播地址； tunel IP上通道

### ip命令学习

1. 查看显示网络设备信息 ip addr show / ip -a(简写)
2. 指定网络设备显示信息 ip link show dev ens33
3. 显示网络设备，详细数据包收发大小情况 ip -s link show dev ens33
4. 关闭、激活网络设备 ip link set ens33 down/up # 关闭网卡
5. 修改网卡MAC地址信息 ip link set ens33 address MAC地址
6. ip命令添加ip信息 ip address add 192.168.178.150/24 dev ens33
   （以上/24表示子网掩码）
   删除ip信息 ip address del 192.168.178.150/24 dev ens33
7. ip命令给网卡添加别名 ip address add 192.168.178.188/24 dev ens33 label ens33:1 # 注意添加完毕后，用ifconfig命令能能看到别名网卡信息
8. 通过ip命令检查路由信息 ip route
9. ip检查ARP缓存（显示网络邻居信息），检查MAC地址信息

## netstat命令学习

显示网络连接情况，路由表信息，端口状态，网络连接情况信息。一个进程服务，运行之后，暴露一个端口号，以及产生响应的进程信息。

### 查看所有网络连接情况

netstat -an # -a:显示all所有的套接字(socket)信息  -n:显示数字地址信息而非主机名

1. 常见字段解释

- proto 套接字使用的协议
- Recv-Q 连接这个套接字的用户，还未拷贝的字节数
- Send-Q 远程主机还未确认的字节数
- Local address 套接字(一个连接情况)本地的地址和端口号
- Forign address 套接字的远程主机地址和端口号
- State 套接字的运行情况，Listen:接听中。

ESTABLISHED 套接字有一个有效连接。
SYN SENT 套接字尝试建立一个连接。
SYN RECV 从网络上收到一个连接请求。
FIN WAIT1 连接正在断开，套接字已关闭
FIN WAIT2 套接字等待远程方中止。连接已关闭，
TIME WAIT在关闭之后，套接字等待处理仍然在网络中的分组
CLOSED 套接字未用。
CLOSE WAIT 远程方已关闭，等待套接字关闭。
LAST ACK 远程方中止，套接字已关闭，等待确认。
LISTEN 套接字监听进来的连接。如果不设置·--listening(-l)或者·--all(-a)选项，将不显示出来这些连接
CLOSING 套接字都已关闭，而还未把所有数据发出。
UNKNOWN 套接字状态未知。

2. 常见参数组合
   netstat -tunlp  # 查看机器正在运行的所有端口情况和进程情况

-t 显示TCP的连接情况
-u 显示UDP的连接情况
-n 不进行DNS解析
-l 只显示正在监听中的套接字情况
-p 显示套接字所属的进程和进程名情况

127.0.0.1 # 本地回环地址，用于机器间内部应用通信，外人无法访问此地址

0.0.0.0 # 绑定机器所有的网卡地址

3. netstat -tunlp |grep 3306 # 检查服务器是否运行3306端口
4. 显示路由表的真实情况 netstat -rn 等同于route -n
5. 显示网络的接口情况 netstat -i # 显示出所有网络接口的列表情况

- Iface 网络设备名字
- MTU 最大的传输单元，单位是字节
- RX-OK/TX-OK 正确接收多少数据包，发送多少数据包
- RX-ERR/TX-ERR 接受、发送数据包时，丢弃了多少数据包
- RX-OVR/TX-OVR 由于错误遗失了多少的数据包
- FLg标记 L:回环地址含义； R:网络接口正在运行； U:接口正在处于活动状态； B:设置广播地址；M:接收所有的数据包； O:表示在该接口上禁止ARP； P:端对端的连接

查看TX-ERR RX-ERR为0，否则表示网络情况不健康，有丢包的现象

6. 查看服务器监听

- netstat -tunlp|grep 3306 # 监听mysql数据库运行
- netstat -tunlp|grep 80 # 监听web服务运行
- netstat -tunlp|grep 443 # 监听https服务是否运行

7. ss 网络查看工具

若无则安装 yum install iproute -y

- ss -an

## ping命令

测试当前主机到目标机器的网络连通性。icmp协议

### 对域名进行ping，也可以检测本机是否能够dns解析

### 对ip地址进行ping，也能省去dns解析的过程

1. ping命令发送给远程主机多少字节的数据
2. 从目标机器收到多少字节的数据
3. icmp_seq表示收到的字节数据序列号，ttl数据包的存活时间，秒为单位，time是两台机器收发数据的延时时间。

### ping命令用于检测主机网络状态

检测本机是否能够进行dns解析
如果显示ping:xxxxxx:未知的名称或服务，可能机器无法上网，也可能无法进行dns解析

验证步骤：

- 检查linux的dns客户端配置文件/etc/resolv.conf，确保文件中，有dns服务器地址。如nameserver 114.114.114.114
- 再次验证能否进行域名解析，能否发送ping命令
- 当ping远程主机时，表示自己机器无法上外网
  ping一个正确存在的公网ip地址，还是出现"Destination Host Unreachable"报错。说明网络配置有问题，需正确配置ip信息、路由网关地址

## telnet命令

1. 用于检测远程主机是否打开了某端口

```bash
# 安装
yum install telnet -y
```

2. 检测远程机器的端口是否打开

```bash
telnet xxxxxx 22
```

## ssh命令

openssh软件包中一个套件命令，使用ssh加密协议进行远程登录，实现对服务器的远程管理。ssh是连接服务器上运行的sshd程序，且后台监听的是22端口

可在终端直接输入ssh指令，常可使用xshell和finalshell

```bash
ssh 用户名@ip地址
-p port端口

ssh xxx@xxxxx -p 2333 # 指定端口远程连接
```

远程执行服务器的命令

```bash
ssh xxx@xxxxx "free -m" # 查看内存情况
```

## wget

wget用于下载指定的url文件

1. 支持断点续传
2. wget支持ftp以及http协议下载
3. wget支持添加代理

安装命令wget

```bash
yum install wget -y
```

- 下载图片
- 下载文件，且指定保存文件名字，通过wget功能参数 -O，下载url资源，指定linux目录保存，且修改文件名
- 限制下载速度，limit参数 wget --limit-rate=1k url
- 断点续传, -c，小写c。下载任务中断后，可实现续传
- 后台运行下载 -b，日志默认输出到wget-log中
- 下载不同端网页，可指定客户端身份。

```bash
# 一般网站识别客户来源，默认下载到PC端页面  
wget -O /tmp/luffy.index   www.luffycity.com 
# 在网站的开发人员工具, network, Headers, User-Agent 
wget --user-agent=xxxx
```

- wget检测网站是否存活
- 安静模式，无信息输出 -q
- 设置超时的时间SECONDS秒 -T
- 重试访问网站 -t
- 不下载任何文件 --spider

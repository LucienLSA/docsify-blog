

# 网站架构中的跳板机、堡垒机
运维管理服务器，必须连接上跳板机才能操控内网中的服务器，登录到目标设备进行维护和操作，作用控制IT系统的运维风险

![image.png](https://s2.loli.net/2024/06/19/LpsFVcvIOSihdKa.png)

## 跳板机优点和缺点
1. 优点：集中式对服务器进行管理

2. 缺点：仅实现服务器登录安全，未实现对运维人员的行为操作监控和审计，使用跳板机过程中，可能在服务器上进行错误操作

## 堡垒机运维思想
- 审计能发现问题和责任人，但无法防止问题的发生
- 只有事先严格监控才能够从源头上解决服务器误操作的事故
- 堡垒机能创建系统账号，账号功能属于角色区分作用，但无法确认账号的执行人

## 堡垒机作用
由于跳板机的缺点，提出的管理服务器的IT堡垒机
1. 核心系统运维和安全审计管理
2. 过滤和拦截非法请求访问，恶意攻击，拒绝不合法命令，进行审计监控、报警和责任追踪
3. 报警、记录、分析、处理

## 堡垒机功能
1. 单点登录
2. 账号管理
3. 身份认证
4. 资源授权
5. 访问控制
6. 操作审计

## 应用场景
1. 多个用户使用同一个账号（情况不多）
2. 一个用户使用多个账户
3. 缺少同一的权限管理平台，难以实现高力度的命令权限控制
4. 传统网络设备无法对运维人员的远程连接命令进行加密、审计

运维管理人员技术落后，难以发现问题的因素和问题的责任

设备账户管理缺失，每一个运维人员直接操控所有服务器，账户密码是及其不安全的，多个运维人员密码丢失、忘记、被破解等等

## 企业角度
更细致对企业IT资产设备进行管理，保证企业的IT设备资产安全、可靠运行，降低人为操作的风险，保证企业资金安全

## 管理角度
运维人员只需记录堡垒机的账号密码，一次登录，即可快捷访问多个管理设备，无须记忆多个账号密码。提高工作效率，对服务器最大化的安全性操作


## JumpServer堡垒机
![JumpServer框架](https://s2.loli.net/2024/06/19/6Yl5wapmED9zj1U.png)

![组件](https://s2.loli.net/2024/06/19/tJPsxenqdbQlhOC.png)

![核心架构](https://s2.loli.net/2024/06/20/DFHuAZnJbEzt6BQ.png)

### JumpServer服务部署
1.硬件配置
2个cpu 4G内存 50G硬盘

2. 运行Jumpserver后台相关，需要软件python3解释器、mysqlserver、mariadb、redis数据库（缓存型数据库）

*linux执行命令需要bash解释器*
如ls命令，交给bash解释器，翻译之后，给linux内核执行

### 部署实践
#### 环境初始化
1. 修改主机hostname
```bash
hostnamectl set-hostname teach_jumpserver
```
2. 关闭防火墙服务
```bash
iptables -F
systemctl disable firewalld
systemctl stop firewalld
getenforce
```



## jumpserver学习与部署
根据官方的文档进行环境要求配置和离线安装
### centos7安装mysql5.7
[https://blog.csdn.net/Z_r_s/article/details/133951058](CentOS 7安装MySQL 5.7【安装及密码配置、字符集配置、远程连接配置】)

mysql可以被远程登录

### 离线安装部署
1. 启动安装的脚本文件
```bash
jmsctl.sh
```
2. 默认不需要支持IPv6
3. 配置持久化目录
是否需要自定义持久化存储，默认不使用目录 /data/jumpserver 
4. 配置mysql
是否使用外部mysql，实际环境需要，作为测试环境不需要，默认使用SQLite
5. 配置redis
是否使用外部redis（用于加速mysql）
6. 配置对外端口
是否需要配置jumpserver对外访问端口 需要

如果有默认端口80被占用，则可选择其它的端口
```
jumpserver web端口（默认80）
jumpserver ssh端口（默认2222）
```
7. 初始化数据库
#### 启动
1. 可以使用如下命令启动, 然后访问
cd /root/jumpserver
./jmsctl.sh start

2. 其它一些管理命令
./jmsctl.sh stop
./jmsctl.sh restart
./jmsctl.sh backup
./jmsctl.sh upgrade
更多还有一些命令, 你可以 ./jmsctl.sh --help 来了解

3. Web 访问
http://192.168.226.131:80
默认用户: admin  默认密码: admin

4. SSH/SFTP 访问
ssh -p2222 admin@192.168.226.131
sftp -P2222 admin@192.168.226.131

5. 更多信息
我们的官网: https://www.jumpserver.org/
我们的文档: https://docs.jumpserver.org/

### 安装部署后的配置文件

### 用户管理设置
#### 新增用户
1. 单个用户信息导入 
设置用户信息，密码，MFA为二次验证。确定用户的安全

2. 按照模板导入或导出
csv或者execl文件

#### 新增用户组
新增一个用户组，将新建用户导入到其中

#### 用户登录
查看工作台等信息

### 资产管理-资产分配
创建资产包括主机、网络设备、数据库、云服务、Web

#### 网域列表
为了解决部分环境（如：混合云）无法直接连接而新增的功能，原理是通过网关服务器进行跳转登录。JMS=>网域网关=>目标资产

#### 平台列表
如主机

#### 标签列表

#### 任务列表

#### 任务监控

#### 添加账号
先选择资产，用户名中需要根据主机的实际用户名添加，选择密码

#### 资产授权
将创建的资产分配出去
1. 创建资产授权规则
财务部用户选择对应的资产，账号可选择所有或者指定账号，可给定动作限制

2. 尝试财务部用户进行登录
查看可支配的资产，进行登录。要求资产主机是开启远程桌面功能的

3. 实际使用剪贴板和文件管理
剪贴板功能，文件管理上传和下载

### 命令过滤规则创建
如果不想让运维人员查看linux主机账号或密码，将进行命令过滤，将关键词进行屏蔽

命令过滤-创建命令组，选择名称，内容为命令如(rm mkdir passwd vim echo)

创建命令过滤规则，命令过滤名称，*表示匹配所有-选择命令组-动作选择审批人（一般拒绝）-优先级数字越小越优先

测试被过滤命令，是被禁止的

**也可创建命令的正则表达式**

### 审计台
#### 仪表盘查看
日志数据，执行命令和修改密码等操作的数据

#### 会话审计
1. 会话记录
即资产和用户的录屏，每一步操作都被监视录屏下来

2. 命令记录
执行命令的风险等级

3. 文件传输 

#### 日志审计
1. 登录日志

2. 操作日志
某用户执行的资源（如Linux主机的命令过滤或Linux禁用命令等等）

3. 改密日志

4. 作业日志
对应控制台的任务列表

### 工作台
#### 资产
可选择使用或者登录的系统平台

#### Web终端
可选择登录的终端

#### 文件管理
查看资产的文件信息

#### 作业中心
1. 快捷命令

2. 作业管理
创建命令的作业和脚本

3. 模板管理

4. 执行历史

### 堡垒机邮件服务设置
#### 基本设置
当前站点URL

#### 邮件设置 
在控制台的用户列表处，增加账户认证，选择生成重置密码链接，将邮件发送给用户

1. 邮件服务器
设置SMTP信息和安全设置，测试邮件发送

#### 消息订阅

#### 终端设置




